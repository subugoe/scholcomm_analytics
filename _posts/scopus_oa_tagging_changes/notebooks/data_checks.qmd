---
title: "data checks"
format: html
---

```{r, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE
)
options(scipen = 999, digits = 4)
knitr::knit_hooks$set(
  inline = function(x) {
    if (is.numeric(x)) {
      return(prettyNum(x, big.mark = ","))
    } else{
      return(x)
    }
  }
)
```

```{r, echo=FALSE,message = FALSE, warning = FALSE}
library(here)
library(DBI)
library(RPostgres)
library(tidyverse)
library(networkD3)
library(htmlwidgets)
library(htmltools)
library(sankeyD3) # Not on CRAN, but here <https://github.com/fbreitwieser/sankeyD3>
library(scales)
library(ggsci)
library(cowplot)
library(roadoi)
library(rcrossref)
```

# Verbindung zum KB

```{r}
kb_con <- dbConnect(RPostgres::Postgres(),
                    host = "biblio-p-db03.fiz-karlsruhe.de",
                    port = 6432,
                    dbname = "kbprod",
                    user =  Sys.getenv("kb_user"),
                    password = Sys.getenv("kb_pwd"),
                    bigint = "numeric")
```

# Anzahl an verloren gegangenen green tags via SQL berechnen

```{sql, connection=kb_con}
select sum(count) as total_count
from (
    select scp07_item_id, scp04_oa_status, scp07_oa_status, count(*) as count
    from unigsdoerner.scp_oa_tagging_temp sott
    where sott.scp04_oa_status ~ 'repositoryvor|repositoryam' and sott.scp07_oa_status !~ 'repositoryvor|repositoryam'
    group by scp07_item_id, scp04_oa_status, scp07_oa_status
) as subquery;
```

# fetch Unpaywall Info


```{r}
green_none_0104_raw <- oadoi_fetch(dois = doi_sample_0104, email = Sys.getenv("roadoi_email"), .progress = "text")

green_none_0104 <- green_none_0104_raw %>%
  select(doi, oa_status, has_repository_copy,oa_locations) %>%
  unnest(oa_locations, keep_empty = TRUE) %>%
  select(doi, oa_status, has_repository_copy, is_best, host_type)

write_csv(green_none_0104, "green_none_0104.csv")
```

```{r}
green_none_0407_raw <- oadoi_fetch(dois = doi_sample_0407, email = Sys.getenv("roadoi_email"), .progress = "text")

green_none_0407 <- green_none_0407_raw %>%
  select(doi, oa_status, has_repository_copy,oa_locations) %>%
  unnest(oa_locations, keep_empty = TRUE) %>%
  select(doi, oa_status, has_repository_copy, is_best, host_type)

write_csv(green_none_0407, "green_none_0407.csv")
```

```{r}
green_none_0104 <- read_csv(here("green_none_0104.csv"))
green_none_0407 <- read_csv(here("green_none_0407.csv"))
```

# Unpaywall Info analysieren


```{r}
green_none_0104 %>%
  summarise(n=n_distinct(doi))

green_none_0104 %>%
  group_by(has_repository_copy) %>%
  summarise(n = n_distinct(doi))

green_none_0104 %>%
  filter(host_type == "repository") %>%
  group_by(oa_status, has_repository_copy, host_type) %>%
  summarise(n= n_distinct(doi)) %>%
  arrange(desc(n))
```

```{r}
upw_0104_recopy <- green_none_0104 %>%
  group_by(has_repository_copy) %>%
  summarise(count= n_distinct(doi)) %>%
  mutate(pct = round(count/sum(count) *100,2)) %>%
  arrange(desc(count))
```

```{r}
upw_0104_host <- green_none_0104 %>%
  group_by(oa_status,has_repository_copy,host_type) %>%
  summarise(count= n_distinct(doi)) %>%
  filter(host_type == "repository") %>%
  ungroup() %>%
  mutate(pct = round(count/sum(count) *100,2)) %>%
  arrange(desc(count))
```

```{r}
write_csv(upw_0104_recopy, here("upw_0104_recopy.csv"))
write_csv(upw_0104_host, here("upw_0104_host.csv"))
```


```{r}
green_none_0407 %>%
  summarise(n=n_distinct(doi))

green_none_0407 %>%
  group_by(has_repository_copy) %>%
  summarise(n = n_distinct(doi))

green_none_0407 %>%
  filter(host_type == "repository") %>%
  group_by(oa_status, has_repository_copy, host_type) %>%
  summarise(n= n_distinct(doi)) %>%
  arrange(desc(n))
```


```{r}
upw_0407_recopy <- green_none_0407 %>%
  group_by(has_repository_copy) %>%
  summarise(count= n_distinct(doi)) %>%
  mutate(pct = round(count/sum(count) *100,2)) %>%
  arrange(desc(count))
```

```{r}
upw_0407_host <- green_none_0407 %>%
  group_by(oa_status,has_repository_copy,host_type) %>%
  summarise(count= n_distinct(doi)) %>%
  filter(host_type == "repository") %>%
  ungroup() %>%
  mutate(pct = round(count/sum(count) *100,2)) %>%
  arrange(desc(count))
```


```{r}
write_csv(upw_0407_recopy, here("upw_0407_recopy.csv"))
write_csv(upw_0407_host, here("upw_0407_host.csv"))
```


# SQl Abfragen f√ºr den check der 10 dois gegen scp_rep

```{sql, connection=kb_con, output.var="kb_check_0104_bdb_raw"}
select i.item_id, i.doi, unnest(i.oa_status) as bdb_oa_status, rawdata.oa_status as rawdata_oa_status
from scp_b_202407.items i 
left join (select
	item_id,
	unnest(xpath('//xocs:oa-article-status/@free-to-read-status', xml_element, array[array['xocs', 'http://www.elsevier.com/xml/xocs/dtd']]))::text as "oa_status"
from (
	select item_id,
		unnest(xpath('/xocs:doc/xocs:meta/xocs:open-access/xocs:oa-article-status', 
		r.xml, 
		array[array['xocs', 'http://www.elsevier.com/xml/xocs/dtd']])) as xml_element
	from scp_rep_202407.repository r 
	where item_id in (
		select item_id  
		from scp_b_202407.items 
		where doi in ('10.1073/pnas.2208540119','10.1186/s13046-022-02282-9','10.4014/jmb.1912.12053',
		'10.3390/genes13061023','10.1038/s41467-020-20130-2','10.1103/physrevb.99.161118',
		'10.1016/j.trb.2022.07.008','10.15171/ijhpm.2019.84','10.18502/cmm.5.2.1160','10.1016/s2214-109x(19)30409-7')
		)
) x) as rawdata 
on i.item_id = rawdata.item_id 
where i.item_id in (
		select item_id  
		from scp_b_202407.items 
		where doi in ('10.1073/pnas.2208540119','10.1186/s13046-022-02282-9','10.4014/jmb.1912.12053',
		'10.3390/genes13061023','10.1038/s41467-020-20130-2','10.1103/physrevb.99.161118',
		'10.1016/j.trb.2022.07.008','10.15171/ijhpm.2019.84','10.18502/cmm.5.2.1160','10.1016/s2214-109x(19)30409-7')
		)
;
```

```{r}
kb_check_0104_oa_bdb_raw <- kb_check_0104_bdb_raw %>%
  select(bdb_oa_status,rawdata_oa_status)
```

```{r}
write_csv(kb_check_0104_oa_bdb_raw, here("kb_check_0104_oa_bdb_raw.csv"))
```


```{sql, connection=kb_con, output.var="kb_check_0407_bdb_raw"}
select i.item_id, i.doi, unnest(i.oa_status) as bdb_oa_status, rawdata.oa_status as rawdata_oa_status
from scp_b_202404.items i 
left join (select
	item_id,
	unnest(xpath('//xocs:oa-article-status/@free-to-read-status', xml_element, array[array['xocs', 'http://www.elsevier.com/xml/xocs/dtd']]))::text as "oa_status"
from (
	select item_id,
		unnest(xpath('/xocs:doc/xocs:meta/xocs:open-access/xocs:oa-article-status', 
		r.xml, 
		array[array['xocs', 'http://www.elsevier.com/xml/xocs/dtd']])) as xml_element
	from scp_rep_202404.repository r 
	where item_id in (
		select item_id  
		from scp_b_202404.items 
		where doi in ('10.5770/cgj.24.488','10.3390/toxins13020091','10.3390/ijerph192315871',
		'10.1111/jrh.12444','10.3390/jcm10153310','10.1016/j.jmaa.2019.02.041',
		'10.1590/1981-6723.21119','10.1093/sleepadvances/zpad032','10.1063/1.5117130','10.1088/1742-6596/2156/1/012227')
		)
) x) as rawdata 
on i.item_id = rawdata.item_id 
where i.item_id in (
		select item_id  
		from scp_b_202404.items 
		where doi in ('10.5770/cgj.24.488','10.3390/toxins13020091','10.3390/ijerph192315871',
		'10.1111/jrh.12444','10.3390/jcm10153310','10.1016/j.jmaa.2019.02.041',
		'10.1590/1981-6723.21119','10.1093/sleepadvances/zpad032','10.1063/1.5117130','10.1088/1742-6596/2156/1/012227')
		)
;
```

```{r}
kb_check_0407_oa_bdb_raw <- kb_check_0407_bdb_raw %>%
  select(bdb_oa_status,rawdata_oa_status)
```

```{r}
write_csv(kb_check_0407_oa_bdb_raw, here("kb_check_0407_oa_bdb_raw.csv"))
```

# Scopus Interface Check

```{r}
scp_interface <- read_csv(here("scp_interface_check.csv"))
```

```{r}
scp_interface_0104 <- scp_interface %>%
  filter(DOI %in% c("10.5770/cgj.24.488","10.3390/TOXINS13020091","10.3390/ijerph192315871","10.1111/jrh.12444","10.3390/jcm10153310","10.1016/j.jmaa.2019.02.041","10.1590/1981-6723.21119","10.1093/sleepadvances/zpad032","10.1063/1.5117130","10.1088/1742-6596/2156/1/012227")) %>%
  select(`Open Access`)
```

```{r}
scp_interface_0407 <- scp_interface %>%
  filter(DOI %in% c("10.1073/pnas.2208540119","10.1186/s13046-022-02282-9","10.4014/jmb.1912.12053","10.3390/genes13061023","10.1038/s41467-020-20130-2","10.1103/PhysRevB.99.161118","10.1016/j.trb.2022.07.008","10.15171/ijhpm.2019.84","10.18502/cmm.5.2.1160","10.1016/S2214-109X(19)30409-7")) %>%
  select(`Open Access`)
```

```{r}
write_csv(scp_interface_0104, here("scp_interface_0104.csv"))
write_csv(scp_interface_0407, here("scp_interface_0407.csv"))
```