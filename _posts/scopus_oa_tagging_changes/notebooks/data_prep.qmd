---
title: "data prep"
format: html
---

```{r, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE
)
options(scipen = 999, digits = 4)
knitr::knit_hooks$set(
  inline = function(x) {
    if (is.numeric(x)) {
      return(prettyNum(x, big.mark = ","))
    } else{
      return(x)
    }
  }
)
```

```{r, echo=FALSE,message = FALSE, warning = FALSE}
library(here)
library(DBI)
library(RPostgres)
library(tidyverse)
library(networkD3)
library(htmlwidgets)
library(htmltools)
library(sankeyD3) # Not on CRAN, but here <https://github.com/fbreitwieser/sankeyD3>
library(scales)
library(ggsci)
library(cowplot)
library(roadoi)
library(rcrossref)
```

# Verbindung zum KB

```{r}
kb_con <- dbConnect(RPostgres::Postgres(),
                    host = "biblio-p-db03.fiz-karlsruhe.de",
                    port = 6432,
                    dbname = "kbprod",
                    user =  Sys.getenv("kb_user"),
                    password = Sys.getenv("kb_pwd"),
                    bigint = "numeric")
```

# SQL Queries zur Tabellenerstellung im KB

``` sql 
create table unigsdoerner.scp_oa_tagging_temp as(
select 
scp07.item_id as scp07_item_id,
scp07.doi as scp07_doi,
scp07.pubyear as scp07_pubyear,
scp01.item_id as scp01_item_id,
scp01.doi as scp01_doi,
scp01.pubyear as scp01_pubyear,
scp04.item_id as scp04_item_id,
scp04.doi as scp04_doi,
scp04.pubyear as scp04_pubyear,
unnest(scp01.oa_status) as scp01_oa_status,
unnest(scp04.oa_status) as scp04_oa_status,
unnest(scp07.oa_status) as scp07_oa_status,
scp01.oa_url as scp01_oa_url,
scp04.oa_url as scp04_oa_url,
scp07.oa_url as scp07_oa_url,
scp01.scopus_oa_licence as scp01_oa_licence,
scp04.scopus_oa_licence as scp04_oa_licence,
scp07.scopus_oa_licence as scp07_oa_licence
from scp_b_202407.items scp07
inner join scp_b_202404.items scp04 on
scp07.item_id = scp04.item_id 
inner join scp_b_202401.items scp01 on
scp07.item_id = scp01.item_id 
where scp07.pubyear between 2019 and 2023
);
```

# Laden der Daten aus der temp Tabelle im KB

```{sql, connection=kb_con, output.var="scp_oa_tagging_temp"}
select * from unigsdoerner.scp_oa_tagging_temp
```

```{r}
write_csv(scp_oa_tagging_temp, here("scp_oa_tagging_temp.csv"))
```

```{r}
scp_oa_tagging_temp <- read_csv(here("scp_oa_tagging_temp.csv"))
```

# Datenmanipulation der temp Tabelle

- Ausschluss eines Eintrags (unterschiedliche dois, aber selbe item_id und unterschiedliche oa tags)
- Ersetzen von NA Werten mit none
- Entfernen von "all" und "repository" in allen Zellen
- Entfernen der Zeilen, die nur "all" oder "repository" enthalten 
- Leerzeichen durch Semikolon ersetzen
- oa tags umbenennen
- Spalten am Semikolon in mehrere Spalten aufteilen

```{r}
temp_prep <- scp_oa_tagging_temp %>%
  select(scp07_item_id,scp07_doi, scp01_oa_status, scp04_oa_status,scp07_oa_status) %>%
  filter(scp07_item_id != "2-s2.0-85181869646") %>%
  mutate(scp01_oa_status = replace(scp01_oa_status, is.na(scp01_oa_status), "none")) %>%
  mutate(scp04_oa_status = replace(scp04_oa_status, is.na(scp04_oa_status), "none")) %>%
  mutate(scp07_oa_status = replace(scp07_oa_status, is.na(scp07_oa_status), "none")) %>%
  mutate(scp01_oa_status = str_replace(scp01_oa_status, "^all ", "")) %>%
  mutate(scp04_oa_status = str_replace(scp04_oa_status, "^all ", "")) %>%
  mutate(scp07_oa_status = str_replace(scp07_oa_status, "^all ", "")) %>%
  mutate(scp01_oa_status = str_replace(scp01_oa_status, "repository ", "")) %>%
  mutate(scp04_oa_status = str_replace(scp04_oa_status, "repository ", "")) %>%
  mutate(scp07_oa_status = str_replace(scp07_oa_status, "repository ", "")) %>%
  filter(!grepl("^(all|repository)$", scp01_oa_status)) %>%
  filter(!grepl("^(all|repository)$", scp04_oa_status)) %>%
  filter(!grepl("^(all|repository)$", scp07_oa_status)) %>%
  mutate(scp01_oa_status = str_replace_all(scp01_oa_status, " ", ";")) %>%
  mutate(scp04_oa_status = str_replace_all(scp04_oa_status, " ", ";")) %>%
  mutate(scp07_oa_status = str_replace_all(scp07_oa_status, " ", ";")) %>%
  mutate(scp01_oa_status = str_replace_all(scp01_oa_status, c("publisherfullgold" = "gold", "publisherhybridgold" = "hybrid", "publisherfree2read" = "bronze", "repositoryvor" = "green (vor)", "repositoryam" = "green (am)"))) %>%
  mutate(scp04_oa_status = str_replace_all(scp04_oa_status, c("publisherfullgold" = "gold", "publisherhybridgold" = "hybrid", "publisherfree2read" = "bronze", "repositoryvor" = "green (vor)", "repositoryam" = "green (am)"))) %>%
  mutate(scp07_oa_status = str_replace_all(scp07_oa_status, c("publisherfullgold" = "gold", "publisherhybridgold" = "hybrid", "publisherfree2read" = "bronze", "repositoryvor" = "green (vor)", "repositoryam" = "green (am)"))) %>%
  separate_wider_delim(scp01_oa_status, delim = ";", names_sep = "_", too_few = "align_start") %>%
  separate_wider_delim(scp04_oa_status, delim = ";", names_sep = "_", too_few = "align_start") %>%
  separate_wider_delim(scp07_oa_status, delim = ";", names_sep = "_", too_few = "align_start")
```

```{r}
write_csv(temp_prep, here("temp_prep.csv"))
```


# Daten für den OA Share vorbereiten

```{r}
scp_oa_share <- scp_oa_tagging_temp %>%
  select(scp07_item_id, scp01_oa_status,scp04_oa_status, scp07_oa_status) %>%
  mutate(scp01_is_oa = ifelse(is.na(scp01_oa_status), "no","yes")) %>%
  mutate(scp04_is_oa = ifelse(is.na(scp04_oa_status), "no","yes")) %>%
  mutate(scp07_is_oa = ifelse(is.na(scp07_oa_status), "no","yes")) %>%
  select(scp07_item_id, scp01_is_oa,scp04_is_oa,scp07_is_oa) %>%
  pivot_longer(
    cols = contains("is_oa"),
    names_to = "snapshot",
    values_to = "is_oa",
    values_drop_na = TRUE     
  ) %>%
  group_by(snapshot, is_oa) %>%
 summarise(
 n = n_distinct(scp07_item_id)
 ) %>%
 group_by(snapshot) %>%
 mutate(
 total = sum(n),
 share = n / total
 )
```

```{r}
write_csv(scp_oa_share, here("scp_oa_share.csv"))
```


# temp_prep dataframe in long format umwandeln

```{r}
scp_oa_tagging_long_prep <- temp_prep %>%
  pivot_longer(
    cols = contains("oa_status"),
    names_to = "snapshot",
    values_to = "oa_status",
    values_drop_na = TRUE     
  ) %>%
  mutate(snapshot = str_replace(snapshot, "_\\d$",""))
```

```{r}
write_csv(scp_oa_tagging_long_prep, here("scp_oa_tagging_long_prep.csv"))
```


# Daten für das Sankey vorbereiten

```{r}
scp_oa_tagging_sn_long <- temp_prep %>%
   mutate(scp01_oa_status_2 = ifelse(is.na(scp01_oa_status_2) & !is.na(scp04_oa_status_2), "missing", scp01_oa_status_2)) %>%
   mutate(scp01_oa_status_3 = ifelse(is.na(scp01_oa_status_3) & !is.na(scp04_oa_status_3), "missing", scp01_oa_status_3)) %>%
   mutate(scp04_oa_status_2 = ifelse(is.na(scp04_oa_status_2) & !is.na(scp01_oa_status_2), "missing", scp04_oa_status_2)) %>%
  mutate(scp04_oa_status_3 = ifelse(is.na(scp04_oa_status_3) & !is.na(scp01_oa_status_3), "missing", scp04_oa_status_3)) %>%
  mutate(scp04_oa_status_2 = ifelse(is.na(scp04_oa_status_2) & !is.na(scp07_oa_status_2), "missing", scp04_oa_status_2)) %>%
  mutate(scp07_oa_status_2 = ifelse(is.na(scp07_oa_status_2) & !is.na(scp04_oa_status_2), "missing", scp07_oa_status_2)) %>%
  mutate(scp07_oa_status_3 = ifelse(is.na(scp07_oa_status_3) & !is.na(scp04_oa_status_3), "missing", scp07_oa_status_3)) %>%
  pivot_longer(
    cols = contains("oa_status"),
    names_to = "snapshot",
    values_to = "oa_status",
    values_drop_na = TRUE     
  ) %>%
  mutate(snapshot = str_replace(snapshot, "_\\d$",""))
```

# Datenmanipulation für das Sankey

## Nodes

```{r}
scp_0104_sn <- scp_oa_tagging_sn_long %>%
  select(scp07_item_id,snapshot, oa_status) %>%
  filter(snapshot != "scp07_oa_status") %>%
  group_by(snapshot, oa_status) %>%
  mutate(n0104 = n_distinct(scp07_item_id))

scp_0407_sn <- scp_oa_tagging_sn_long %>%
  select(scp07_item_id,snapshot, oa_status) %>%
  filter(snapshot != "scp01_oa_status") %>%
  group_by(snapshot, oa_status) %>%
  mutate(n0407 = n_distinct(scp07_item_id))

scp_0104_nodes_prep <- scp_0104_sn %>%
  select(-scp07_item_id) %>%
  distinct() %>%
  mutate(oa_status = ifelse(snapshot == "scp01_oa_status", toupper(oa_status), 
          ifelse(snapshot == "scp04_oa_status", str_to_title(oa_status), oa_status)))

scp_0407_nodes_prep <- scp_0407_sn %>%
  select(-scp07_item_id) %>%
  distinct() %>%
  mutate(oa_status = ifelse(snapshot == "scp04_oa_status", str_to_title(oa_status), oa_status))

scp_147 <- bind_rows(scp_0104_nodes_prep,scp_0407_nodes_prep)
scp_147 <- scp_147 %>%
  select(snapshot, oa_status) %>%
  arrange(snapshot) %>%
  distinct() %>%
  ungroup()

nodes <- scp_147 %>%
 mutate(snapshot = row_number()) %>%
 rename(name = snapshot) %>%
 mutate(name = as.character(name)) %>%
 rename(label = oa_status)
```

```{r}
write_csv(nodes, here("nodes.csv"))
```


## Links

```{r}
temp_prep_sn <- temp_prep %>%
   mutate(scp01_oa_status_2 = ifelse(is.na(scp01_oa_status_2) & !is.na(scp04_oa_status_2), "missing", scp01_oa_status_2)) %>%
   mutate(scp01_oa_status_3 = ifelse(is.na(scp01_oa_status_3) & !is.na(scp04_oa_status_3), "missing", scp01_oa_status_3)) %>%
   mutate(scp04_oa_status_2 = ifelse(is.na(scp04_oa_status_2) & !is.na(scp01_oa_status_2), "missing", scp04_oa_status_2)) %>%
  mutate(scp04_oa_status_3 = ifelse(is.na(scp04_oa_status_3) & !is.na(scp01_oa_status_3), "missing", scp04_oa_status_3)) %>%
  mutate(scp04_oa_status_2 = ifelse(is.na(scp04_oa_status_2) & !is.na(scp07_oa_status_2), "missing", scp04_oa_status_2)) %>%
  mutate(scp07_oa_status_2 = ifelse(is.na(scp07_oa_status_2) & !is.na(scp04_oa_status_2), "missing", scp07_oa_status_2)) %>%
  mutate(scp07_oa_status_3 = ifelse(is.na(scp07_oa_status_3) & !is.na(scp04_oa_status_3), "missing", scp07_oa_status_3))
```


```{r}
st1 <- temp_prep_sn %>%
  select(scp07_item_id, scp01_oa_status_1, scp04_oa_status_1) %>%
  mutate(source = toupper(scp01_oa_status_1)) %>%
  mutate(target = str_to_title(scp04_oa_status_1)) %>%
  select(scp07_item_id, source, target)

st2 <- temp_prep_sn %>%
  select(scp07_item_id, scp01_oa_status_2, scp04_oa_status_2) %>%
  filter(!(is.na(scp01_oa_status_2) & is.na(scp04_oa_status_2))) %>%
  mutate(source = toupper(scp01_oa_status_2)) %>%
  mutate(target = str_to_title(scp04_oa_status_2)) %>%
  select(scp07_item_id, source, target)

st3 <- temp_prep_sn %>%
  select(scp07_item_id, scp01_oa_status_3, scp04_oa_status_3) %>%
  filter(!(is.na(scp01_oa_status_3) & is.na(scp04_oa_status_3))) %>%
  mutate(source = toupper(scp01_oa_status_3)) %>%
  mutate(target = str_to_title(scp04_oa_status_3)) %>%
  select(scp07_item_id, source, target)

scp0104_links_prep <- bind_rows(st1,st2,st3)
stn <- scp0104_links_prep %>%
  group_by(source, target) %>%
  summarise(n = n_distinct(scp07_item_id))

st4 <- temp_prep_sn %>%
  select(scp07_item_id, scp04_oa_status_1, scp07_oa_status_1) %>%
  mutate(source = str_to_title(scp04_oa_status_1)) %>%
  mutate(target = scp07_oa_status_1) %>%
  select(scp07_item_id, source, target)

st5 <- temp_prep_sn %>%
  select(scp07_item_id, scp04_oa_status_2, scp07_oa_status_2) %>%
  filter(!(is.na(scp04_oa_status_2) & is.na(scp07_oa_status_2))) %>%
  mutate(source = str_to_title(scp04_oa_status_2)) %>%
  mutate(target = scp07_oa_status_2) %>%
  select(scp07_item_id, source, target)

st6 <- temp_prep_sn %>%
  select(scp07_item_id, scp04_oa_status_3, scp07_oa_status_3) %>%
  filter(!(is.na(scp04_oa_status_3) & is.na(scp07_oa_status_3))) %>%
  mutate(source = str_to_title(scp04_oa_status_3)) %>%
  mutate(target = scp07_oa_status_3) %>%
  select(scp07_item_id, source, target)

scp0407_links_prep <- bind_rows(st4,st5,st6)
stn2 <- scp0407_links_prep %>%
  group_by(source, target) %>%
  summarise(n = n_distinct(scp07_item_id))

links <- bind_rows(stn,stn2) %>%
         mutate(source = match(source, nodes$label) -1,
                target = match(target, nodes$label) -1)

#links
links <- links %>%
  filter(!is.na(source))
```

```{r}
write_csv(links, here("links.csv"))
```



# Sample DOIs for Unpaywall check

```{r}
doi_sample_0407 <- scp_oa_tagging_temp %>%
  select(scp07_doi, scp04_oa_status,scp07_oa_status) %>%
  filter(grepl("repositoryvor|repositoryam", scp04_oa_status) & !grepl("repositoryvor|repositoryam", scp07_oa_status)) %>%
 filter(!is.na(scp07_doi)) %>%
 filter(!duplicated(scp07_doi)) %>%
 sample_n(10000) %>%
 pull(scp07_doi)
```

```{r}
doi_sample_0104 <- scp_oa_tagging_temp %>%
  select(scp07_doi, scp01_oa_status,scp04_oa_status) %>%
  filter(grepl("repositoryvor|repositoryam", scp01_oa_status) & !grepl("repositoryvor|repositoryam", scp04_oa_status)) %>%
 filter(!is.na(scp07_doi)) %>%
 filter(!duplicated(scp07_doi)) %>%
 sample_n(10000) %>%
 pull(scp07_doi)
```


# Sample DOIs für KB check

```{r}
kb_check_0104 <- green_none_0104 %>%
  filter(host_type  == "repository") %>%
  distinct(doi) %>%
  sample_n(10) %>%
  pull(doi)
```


```{r}
kb_check_0407 <- green_none_0407 %>%
  filter(host_type  == "repository") %>%
  distinct(doi) %>%
  sample_n(10) %>%
  pull(doi)
```


```{r}
kb_0104 <- as.tibble(kb_check_0104)
kb_0407 <- as.tibble(kb_check_0407)

kb_check <- bind_rows(kb_0104,kb_0407)

#write_csv(kb_check, here("kb_check.csv"))

write.table(kb_check, file = "kb_check.txt", row.names = FALSE,col.names = FALSE)
```

